<script>
    const oauthChannel = new BroadcastChannel('oauth_channel');
    oauthChannel.onmessage = function (event) {
        const response = event.data;
        setTimeout(async () => {
            if (response.action === "refresh") {
                await loadOAuthStatus()
            }
        }, 1000);
        if (response.status === true) {
            notyf.success(response.message);
        } else {
            notyf.error(response.message);
        }
    }

    async function loadOAuthStatus() {
        const container = document.getElementById('oauth-list-container');

        try {
            const response = await fetch('/api/oauth/list');
            const result = await response.json();
            if (!result.status) throw new Error(result.msg);

            const {providers, linked} = result.data;
            let html = '<div class="oauth-manage-list">';

            for (const [slug, info] of Object.entries(providers)) {
                const isBound = linked.hasOwnProperty(slug);
                const userName = isBound ? linked[slug].provider_preferred_username : '';

                html += `
                <div class="oauth-row">
                    <div class="d-flex align-items-center">
                        <div class="oauth-icon-circle">
                            <img src="${info.icon}" alt="${slug}">
                        </div>
                        <div class="oauth-info">
                            <span class="oauth-name">${info.friendly_name || slug}</span>
                            <span class="text-light mx-1">:</span>
                            <span class="oauth-status-text ${isBound ? 'text-success' : 'text-light'}">
                                ${isBound ? '{{ "OAUTH_LINKED" | gettext }}' : '{{ "OAUTH_UNLINKED" | gettext }}'}
                            </span>
                            ${isBound ? `<div class="oauth-username">${userName}</div>` : ''}
                        </div>
                    </div>
                    <div class="oauth-action">
                        ${isBound
                    ? `<button class="btn-oauth-action text-danger" onclick="unbindOAuth('${slug}')">{{ "OAUTH_UNLINK" | gettext }}</button>`
                    : `<button class="btn-oauth-action text-primary"onclick="bindOAuth('${slug}')">{{ "OAUTH_LINK" | gettext }}</button>`
                }
                    </div>
                </div>
            `;
            }
            html += '</div>';
            if (Object.keys(providers).length === 0) {
                container.innerHTML = '<p class="text-center text-muted p-4">{{ "OAUTH_NO_PROVIDER" | gettext }}</p>';
            } else {
                container.innerHTML = html;
            }

        } catch (error) {
            container.innerHTML = `<div class="alert alert-danger">${error.message}</div>`;
        }
    }

    async function unbindOAuth(slug) {
        try {
            const response = await fetch(`/api/oauth/unlink/${slug}`);
            const result = await response.json();

            if (typeof notyf !== 'undefined') {
                result.status ? notyf.success(result.msg) : notyf.error(result.msg);
            }
            await loadOAuthStatus();
        } catch (error) {
            if (typeof notyf !== 'undefined') notyf.error("{{ "OAUTH_UNBIND_FAILED" | gettext }}");
        }
    }

    function bindOAuth(slug) {
        const url = `/api/oauth/link/${slug}`;
        const w = 600, h = 700;
        const left = (window.screen.width - w) / 2;
        const top = (window.screen.height - h) / 2;
        window.open(url, 'oauth_window', `width=${w},height=${h},left=${left},top=${top}`);
    }

</script>