# Generated by Django 5.2.9 on 2026-01-07 08:46
# Modified to fix MongoDB compatibility (issue #681)
#
# IMPORTANT: This migration detects MongoDB by checking the database backend configuration.
# Detection methods (in order of preference):
# 1. DATABASES['default']['ENGINE'] setting (supports both env vars and local configs)
# 2. MONGODB_HOST environment variable (fallback for early initialization)
#
# The migration creates different indexes based on the database backend:
# - MongoDB: Only creates reverse indexes (-date, -time) since forward indexes 
#            are automatically created by db_index=True
# - Other DBs: Creates all explicit indexes for compatibility

from django.db import migrations, models
import os


def _detect_mongodb_backend():
    """
    Detect if MongoDB is being used by checking the database backend setting.
    
    This function checks the DATABASES configuration to determine the backend,
    which is more reliable than only checking environment variables as it works
    with both environment-based and local config.py deployments.
    """
    # First, try to check the actual DATABASES setting
    try:
        from django.conf import settings
        if settings.configured:
            db_engine = settings.DATABASES.get('default', {}).get('ENGINE', '')
            if 'mongodb' in db_engine.lower():
                return True
    except Exception:
        # Settings not yet configured, fall back to checking environment
        pass
    
    # Fallback: Check environment variable (works during early import)
    # This handles the case where settings aren't configured yet
    return bool(os.environ.get("MONGODB_HOST"))


def get_conditional_operations():
    """
    Generate migration operations based on database backend.
    
    This detects the database backend at import time to determine which indexes
    to create. The operations list must be available at import time, so we check
    the database configuration before any connections are made.
    """
    use_mongodb = _detect_mongodb_backend()
    
    # Base operations (AlterField with db_index=True)
    base_ops = [
        migrations.AlterField(
            model_name='cache',
            name='name',
            field=models.TextField(db_index=True, max_length=2147483647),
        ),
        migrations.AlterField(
            model_name='custommodel',
            name='name',
            field=models.TextField(db_index=True, max_length=2147483647),
        ),
        migrations.AlterField(
            model_name='friendmodel',
            name='status',
            field=models.BooleanField(db_index=True, default=True),
        ),
        migrations.AlterField(
            model_name='friendmodel',
            name='time',
            field=models.TextField(db_index=True, max_length=2147483647),
        ),
        migrations.AlterField(
            model_name='imagemodel',
            name='name',
            field=models.TextField(db_index=True, max_length=2147483647),
        ),
        migrations.AlterField(
            model_name='postmodel',
            name='date',
            field=models.FloatField(db_index=True),
        ),
        migrations.AlterField(
            model_name='postmodel',
            name='path',
            field=models.TextField(db_index=True, max_length=2147483647),
        ),
        migrations.AlterField(
            model_name='postmodel',
            name='status',
            field=models.BooleanField(db_index=True, default=True),
        ),
        migrations.AlterField(
            model_name='settingmodel',
            name='name',
            field=models.TextField(db_index=True, max_length=2147483647),
        ),
        migrations.AlterField(
            model_name='statisticpv',
            name='url',
            field=models.URLField(db_index=True),
        ),
        migrations.AlterField(
            model_name='statisticuv',
            name='ip',
            field=models.GenericIPAddressField(db_index=True),
        ),
        migrations.AlterField(
            model_name='talkmodel',
            name='time',
            field=models.TextField(db_index=True, max_length=2147483647),
        ),
    ]
    
    # Add explicit indexes based on database backend
    if not use_mongodb:
        # For non-MongoDB databases, create all indexes explicitly
        base_ops.extend([
            migrations.AddIndex(
                model_name='cache',
                index=models.Index(fields=['name'], name='hexoweb_cac_name_393d54_idx'),
            ),
            migrations.AddIndex(
                model_name='custommodel',
                index=models.Index(fields=['name'], name='hexoweb_cus_name_5ca240_idx'),
            ),
            migrations.AddIndex(
                model_name='friendmodel',
                index=models.Index(fields=['time'], name='hexoweb_fri_time_a9636e_idx'),
            ),
            migrations.AddIndex(
                model_name='friendmodel',
                index=models.Index(fields=['status'], name='hexoweb_fri_status_efb727_idx'),
            ),
            migrations.AddIndex(
                model_name='imagemodel',
                index=models.Index(fields=['name'], name='hexoweb_ima_name_6a60d9_idx'),
            ),
            migrations.AddIndex(
                model_name='imagemodel',
                index=models.Index(fields=['-date'], name='hexoweb_ima_date_dee9c4_idx'),
            ),
            migrations.AddIndex(
                model_name='postmodel',
                index=models.Index(fields=['path'], name='hexoweb_pos_path_3952f0_idx'),
            ),
            migrations.AddIndex(
                model_name='postmodel',
                index=models.Index(fields=['-date'], name='hexoweb_pos_date_38e4f3_idx'),
            ),
            migrations.AddIndex(
                model_name='postmodel',
                index=models.Index(fields=['status'], name='hexoweb_pos_status_989f04_idx'),
            ),
            migrations.AddIndex(
                model_name='settingmodel',
                index=models.Index(fields=['name'], name='hexoweb_set_name_3e7cb3_idx'),
            ),
            migrations.AddIndex(
                model_name='statisticpv',
                index=models.Index(fields=['url'], name='hexoweb_sta_url_a0e580_idx'),
            ),
            migrations.AddIndex(
                model_name='statisticuv',
                index=models.Index(fields=['ip'], name='hexoweb_sta_ip_b9eddf_idx'),
            ),
            migrations.AddIndex(
                model_name='talkmodel',
                index=models.Index(fields=['time'], name='hexoweb_tal_time_a7d991_idx'),
            ),
            migrations.AddIndex(
                model_name='talkmodel',
                index=models.Index(fields=['-time'], name='hexoweb_tal_time_7eb94e_idx'),
            ),
        ])
    else:
        # For MongoDB, only add reverse indexes (which can't be expressed by db_index=True)
        base_ops.extend([
            migrations.AddIndex(
                model_name='imagemodel',
                index=models.Index(fields=['-date'], name='hexoweb_ima_date_dee9c4_idx'),
            ),
            migrations.AddIndex(
                model_name='postmodel',
                index=models.Index(fields=['-date'], name='hexoweb_pos_date_38e4f3_idx'),
            ),
            migrations.AddIndex(
                model_name='talkmodel',
                index=models.Index(fields=['-time'], name='hexoweb_tal_time_7eb94e_idx'),
            ),
        ])
    
    return base_ops


class Migration(migrations.Migration):

    dependencies = [
        ('hexoweb', '0003_imagemodel_deleteconfig'),
    ]

    operations = get_conditional_operations()
