# Generated by Django 5.2.9 on 2026-01-07 08:46
# Modified to fix MongoDB compatibility (issue #681)
#
# IMPORTANT: This migration detects MongoDB by checking the MONGODB_HOST environment variable.
# Ensure this variable is set correctly before running migrations:
# - Set MONGODB_HOST=<your_mongodb_connection_string> for MongoDB deployments
# - Leave MONGODB_HOST unset for PostgreSQL, MySQL, or SQLite deployments
#
# Note: We use the environment variable instead of schema_editor.connection.vendor because:
# 1. The operations list must be determined at import time (before database connection)
# 2. Django migrations don't support runtime evaluation of the operations list
# 3. MONGODB_HOST is the standard way this application detects MongoDB configuration
#
# The migration creates different indexes based on the database backend:
# - MongoDB: Only creates reverse indexes (-date, -time) since forward indexes 
#            are automatically created by db_index=True
# - Other DBs: Creates all explicit indexes for compatibility

from django.db import migrations, models
import os


def get_conditional_operations():
    """
    Generate migration operations based on database backend.
    
    This checks MONGODB_HOST environment variable at import time to determine
    which indexes to create. This is the correct approach because:
    1. The environment variable is set before Django starts
    2. It remains constant throughout the application lifecycle
    3. Migration files are not shared between different deployment types
    4. The operations list must be available at import time
    """
    use_mongodb = bool(os.environ.get("MONGODB_HOST"))
    
    # Base operations (AlterField with db_index=True)
    base_ops = [
        migrations.AlterField(
            model_name='cache',
            name='name',
            field=models.TextField(db_index=True, max_length=2147483647),
        ),
        migrations.AlterField(
            model_name='custommodel',
            name='name',
            field=models.TextField(db_index=True, max_length=2147483647),
        ),
        migrations.AlterField(
            model_name='friendmodel',
            name='status',
            field=models.BooleanField(db_index=True, default=True),
        ),
        migrations.AlterField(
            model_name='friendmodel',
            name='time',
            field=models.TextField(db_index=True, max_length=2147483647),
        ),
        migrations.AlterField(
            model_name='imagemodel',
            name='name',
            field=models.TextField(db_index=True, max_length=2147483647),
        ),
        migrations.AlterField(
            model_name='postmodel',
            name='date',
            field=models.FloatField(db_index=True),
        ),
        migrations.AlterField(
            model_name='postmodel',
            name='path',
            field=models.TextField(db_index=True, max_length=2147483647),
        ),
        migrations.AlterField(
            model_name='postmodel',
            name='status',
            field=models.BooleanField(db_index=True, default=True),
        ),
        migrations.AlterField(
            model_name='settingmodel',
            name='name',
            field=models.TextField(db_index=True, max_length=2147483647),
        ),
        migrations.AlterField(
            model_name='statisticpv',
            name='url',
            field=models.URLField(db_index=True),
        ),
        migrations.AlterField(
            model_name='statisticuv',
            name='ip',
            field=models.GenericIPAddressField(db_index=True),
        ),
        migrations.AlterField(
            model_name='talkmodel',
            name='time',
            field=models.TextField(db_index=True, max_length=2147483647),
        ),
    ]
    
    # Add explicit indexes based on database backend
    if not use_mongodb:
        # For non-MongoDB databases, create all indexes explicitly
        base_ops.extend([
            migrations.AddIndex(
                model_name='cache',
                index=models.Index(fields=['name'], name='hexoweb_cac_name_393d54_idx'),
            ),
            migrations.AddIndex(
                model_name='custommodel',
                index=models.Index(fields=['name'], name='hexoweb_cus_name_5ca240_idx'),
            ),
            migrations.AddIndex(
                model_name='friendmodel',
                index=models.Index(fields=['time'], name='hexoweb_fri_time_a9636e_idx'),
            ),
            migrations.AddIndex(
                model_name='friendmodel',
                index=models.Index(fields=['status'], name='hexoweb_fri_status_efb727_idx'),
            ),
            migrations.AddIndex(
                model_name='imagemodel',
                index=models.Index(fields=['name'], name='hexoweb_ima_name_6a60d9_idx'),
            ),
            migrations.AddIndex(
                model_name='imagemodel',
                index=models.Index(fields=['-date'], name='hexoweb_ima_date_dee9c4_idx'),
            ),
            migrations.AddIndex(
                model_name='postmodel',
                index=models.Index(fields=['path'], name='hexoweb_pos_path_3952f0_idx'),
            ),
            migrations.AddIndex(
                model_name='postmodel',
                index=models.Index(fields=['-date'], name='hexoweb_pos_date_38e4f3_idx'),
            ),
            migrations.AddIndex(
                model_name='postmodel',
                index=models.Index(fields=['status'], name='hexoweb_pos_status_989f04_idx'),
            ),
            migrations.AddIndex(
                model_name='settingmodel',
                index=models.Index(fields=['name'], name='hexoweb_set_name_3e7cb3_idx'),
            ),
            migrations.AddIndex(
                model_name='statisticpv',
                index=models.Index(fields=['url'], name='hexoweb_sta_url_a0e580_idx'),
            ),
            migrations.AddIndex(
                model_name='statisticuv',
                index=models.Index(fields=['ip'], name='hexoweb_sta_ip_b9eddf_idx'),
            ),
            migrations.AddIndex(
                model_name='talkmodel',
                index=models.Index(fields=['time'], name='hexoweb_tal_time_a7d991_idx'),
            ),
            migrations.AddIndex(
                model_name='talkmodel',
                index=models.Index(fields=['-time'], name='hexoweb_tal_time_7eb94e_idx'),
            ),
        ])
    else:
        # For MongoDB, only add reverse indexes (which can't be expressed by db_index=True)
        base_ops.extend([
            migrations.AddIndex(
                model_name='imagemodel',
                index=models.Index(fields=['-date'], name='hexoweb_ima_date_dee9c4_idx'),
            ),
            migrations.AddIndex(
                model_name='postmodel',
                index=models.Index(fields=['-date'], name='hexoweb_pos_date_38e4f3_idx'),
            ),
            migrations.AddIndex(
                model_name='talkmodel',
                index=models.Index(fields=['-time'], name='hexoweb_tal_time_7eb94e_idx'),
            ),
        ])
    
    return base_ops


class Migration(migrations.Migration):

    dependencies = [
        ('hexoweb', '0003_imagemodel_deleteconfig'),
    ]

    operations = get_conditional_operations()
